<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog 
	  xmlns="http://www.liquibase.org/xml/ns/dbchangelog" 
	  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" 
	  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    
    <!--
        catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" 
        baseTableCatalogName="${POSTGRES_CATALOG}" baseTableSchemaName="${POSTGRES_SCHEMA}" referencedTableCatalogName="${POSTGRES_CATALOG}" referencedTableSchemaName="${POSTGRES_SCHEMA}" 
    -->

    <changeSet author="Carol Geisler" id="tag0">
    	<tagDatabase tag="ddl_set_05_leave_start"/>
    </changeSet>

    <!--
        Leave Support tables
    -->
    
    <!-- create table leave_code -->
    <changeSet author="Carol Geisler" id="CRTTAB_leave_code">
    	<comment>Create the Leave Type table to capture categories of leave being managed.</comment>
				<createTable catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_code" 
        	remarks="Leave Type Code captures the different categories of leave being managed. Initial types are
				Leave
				Training">
            <column name="leave_code" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="effective_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="expiry_date" type="date"/>
            <column name="created_by" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="created_dtm" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_dtm" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="revision_count" type="numeric(10)">
                <constraints nullable="false"/>
            </column>
				</createTable>
        <addPrimaryKey columnNames="leave_code" constraintName="pk_lvcd" catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_code"/>
        <sql>
        	GRANT SELECT ON ${POSTGRES_SCHEMA}.leave_code to ${POSTGRES_APP_USER};
        </sql>
        <rollback>
        	<dropTable  cascadeConstraints="true" catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_code"/>
        </rollback>
    </changeSet>
    
    <!-- create table leave_code -->
    <changeSet author="Carol Geisler" id="CRTTAB_leave_sub_code">
    	<comment>Create the Leave Sub Type table to capture sub types of leave being managed in each category.</comment>
				<createTable catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_sub_code" 
        	remarks="Leave Type Sub Code captures the different types of leave being managed in each category. Initial types are
				Leave -     STIP (Short Term Illness)
				Leave -     Annual Leave
				Leave -     Special Leave
				Training -  Training">
            <column name="leave_code" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
             <column name="leave_sub_code" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="effective_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="expiry_date" type="date"/>
            <column name="created_by" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="created_dtm" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_dtm" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="revision_count" type="numeric(10)">
                <constraints nullable="false"/>
            </column>
				</createTable>
        <addPrimaryKey columnNames="leave_code,leave_sub_code" constraintName="pk_lvsbcd" catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_sub_code"/>
        <sql>
        	GRANT SELECT ON ${POSTGRES_SCHEMA}.leave_sub_code to ${POSTGRES_APP_USER};
        </sql>
        <rollback>
        	<dropTable  cascadeConstraints="true" catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_sub_code"/>
        </rollback>
    </changeSet>
    
    
    <!-- create table leave_cancel_reason_code -->
    <changeSet author="Carol Geisler" id="CRTTAB_leave_cancel_reason_code">
    	<comment>Create the Leave Cancel Reason Type table to map capture reasons if a leave is cancelled.</comment>
				<createTable catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_cancel_reason_code" 
        	remarks="Leave Cancel Reason Code captures the reasons for cancellation of leave, for BI and auditing purposes. Initial values are
				- Operational Demands
				- Personal Decision
			- Entry Error">
            <column name="leave_cancel_reason_code" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="effective_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="expiry_date" type="date"/>
            <column name="created_by" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="created_dtm" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_dtm" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="revision_count" type="numeric(10)">
                <constraints nullable="false"/>
            </column>
				</createTable>
        <addPrimaryKey columnNames="leave_cancel_reason_code" constraintName="pk_lvcr" catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_cancel_reason_code"/>
        <sql>
        	GRANT SELECT ON ${POSTGRES_SCHEMA}.leave_cancel_reason_code to ${POSTGRES_APP_USER};
        </sql>
        <rollback>
        	<dropTable  cascadeConstraints="true" catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave_cancel_reason_code"/>
        </rollback>
    </changeSet>
    
        <!-- create table leave_cancel_reason_code -->
    <changeSet author="Carol Geisler" id="CRTTAB_leave">
    	<comment>Create the Leave table to capture planned sheriff leaves of absence.</comment>
				<createTable catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave" 
        	remarks="Leave captures data related to absence from regular duty for one or more full days.">
            <column name="leave_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="sheriff_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="leave_code" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="leave_sub_code" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="DATE WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="DATE WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="start_time" type="TIME WITH TIME ZONE"/>
            <column name="end_time" type="TIME WITH TIME ZONE"/>
            <column name="partial_day_ind" type="INTEGER" defaultValueNumeric="0">
            	  <constraints nullable="false"/>
            </column>
            <column name="comment" type="VARCHAR(200)"/>
            <column name="cancelled_dtm" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="leave_cancel_reason_code" type="VARCHAR(20)"/>
        </createTable>
        <addPrimaryKey columnNames="leave_id" constraintName="pk_lve" catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave"/>
        <addForeignKeyConstraint baseTableCatalogName="${POSTGRES_CATALOG}" baseTableSchemaName="${POSTGRES_SCHEMA}" baseColumnNames="leave_code,leave_sub_code" baseTableName="leave" constraintName="fk_lve_lvsbcd" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedTableCatalogName="${POSTGRES_CATALOG}" referencedTableSchemaName="${POSTGRES_SCHEMA}" referencedColumnNames="leave_code,leave_sub_code" referencedTableName="leave_sub_code"/>
        <addForeignKeyConstraint baseTableCatalogName="${POSTGRES_CATALOG}" baseTableSchemaName="${POSTGRES_SCHEMA}" baseColumnNames="leave_cancel_reason_code" baseTableName="leave" constraintName="fk_lve_lvcr" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedTableCatalogName="${POSTGRES_CATALOG}" referencedTableSchemaName="${POSTGRES_SCHEMA}" referencedColumnNames="leave_cancel_reason_code" referencedTableName="leave_cancel_reason_code"/>
        <addForeignKeyConstraint baseTableCatalogName="${POSTGRES_CATALOG}" baseTableSchemaName="${POSTGRES_SCHEMA}" baseColumnNames="sheriff_id" baseTableName="leave" constraintName="fk_lve_shrf" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedTableCatalogName="${POSTGRES_CATALOG}" referencedTableSchemaName="${POSTGRES_SCHEMA}" referencedColumnNames="sheriff_id" referencedTableName="sheriff"/>
        <sql>
        	GRANT SELECT, INSERT, UPDATE, DELETE ON ${POSTGRES_SCHEMA}.leave to ${POSTGRES_APP_USER};
        </sql>
        <rollback>
        	<dropTable  cascadeConstraints="true" catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave"/>
        </rollback>
    </changeSet>
    
    <changeSet author="Carol Geisler" id="ADDCOL_leave_auditcols">
    	<comment>Add the missed audit columns to the Leave table</comment>
    	  <addColumn catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" tableName="leave">
            <column name="created_by" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="created_dtm" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_dtm" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="revision_count" type="numeric(10)">
                <constraints nullable="false"/>
            </column>
	    	</addColumn>
    </changeSet>
    
    <changeSet author="Carol Geisler" id="DRPNN_lve_end_date">
      <comment>With the inclusion of partial day leaves in the table, the end_date will be conditionally optional. Note: full constraints to be added later.</comment>
      <dropNotNullConstraint catalogName="${POSTGRES_CATALOG}" schemaName="${POSTGRES_SCHEMA}" columnName="end_date" tableName="leave"/>
    </changeSet>
    
    <changeSet author="Carol Geisler" id="tag1">
    	<tagDatabase tag="ddl_set_05_leave_end"/>
    </changeSet>

</databaseChangeLog>
